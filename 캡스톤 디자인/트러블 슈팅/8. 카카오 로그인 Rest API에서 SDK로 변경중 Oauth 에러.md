## 문제 
- react에서 Rest API 방식으로 로그인 할때는 window.location.href = `${baseUrl}/oauth2/authorization/kakao`를 사용한다
	- 이 방식은 프론트엔드가 uri를 백엔드로 전송한다
	- 백엔드에서 spring security가 자동으로 카카오로부터 code를 받아서 카카오로 보낸다음 token을 받는다
	- 받은 token을 저장하고 accesstoken과 refreshtoken을 프론트로 보낸다
- react에서 SDK 방식으로 로그인 할 때는 window.Kakao.Auth.authorize({ redirectUri })방식을 사용한다
	- 이 방식은 프론트엔드가 백엔드를 거치지 않고 카카오Oauth로 직접 요청을 보낸다.
	- 따라서 백엔드는 code가 있는지도 모르고 카카오가 백엔드로 code를 보내줄때 사용자가 로그인 했다는 것을 알 수 있다.(이때 카카오에 등록한 redirect-uri로 code를 보내준다)
	- 백엔드에서는 아무것도 모르고 코드만 알기 때문에 security에서 자동으로 토큰을 만들어주지 못하여서 수동으로 토큰을 만들어줘야한다.

## 해결
- /api/auth/kakao/callback?code=코드를 get으로 카카오로 부터 받는다
- code를 다시 카카오로 보내서 accessToken을 백엔드에게 준다
- 백엔드가 다시 카카오(`https://kapi.kakao.com/v2/user/me`)에 요청해서 이메일과 실명을 받아와서 프론트에 보낼 access,refresh token을 만든다
- 프론트에 보낸다

---
## AI 답변
### 1. ✅ REST API 방식 (Spring Security 자동)

> **요약:** "프론트엔드가 백엔드에게 '다녀오겠습니다' 하고 보고하고 가는 방식"

- **맞는 설명:** 백엔드(`/oauth2/authorization/kakao`)를 거쳐서 가기 때문에, 스프링 시큐리티가 **"이 유저는 내가 보낸 유저다"라는 표식(State)**을 세션에 저장해둡니다.
    
- **결과:** 돌아왔을 때 표식이 확인되므로 **자동**으로 토큰 교환부터 로그인까지 다 해줍니다.
    

### 2. ✅ SDK 방식 (Manual 수동)

> **요약:** "프론트엔드가 백엔드 몰래 카카오랑 직거래하고, 결과물(Code)만 던져주는 방식"

- **맞는 설명:** 백엔드를 안 거치고 갔기 때문에, 백엔드에는 **표식(State)**이 없습니다.
    
- **문제점:** 이 상태로 자동 처리 주소(`/login/oauth2/code/kakao`)로 가면, 스프링 시큐리티가 **"난 널 보낸 적이 없는데? (State 불일치)"** 하고 에러를 냅니다.
    
- **결과:** 따라서 보안 검사를 하지 않는 **별도의 컨트롤러**를 만들어서 직접 처리해야 합니다.
    

### 3. ✅ 해결 방안 (Custom Controller)

작성하신 해결 프로세스도 **정확한 정석 방법**입니다.

1. **Code 수신:**
    
    - `/api/auth/kakao/callback` (직접 만든 주소)에서 `code`를 받습니다.
        
	1. **Access Token 교환 (수동):**
    
    - `RestTemplate`이나 `WebClient`를 써서 카카오(`https://kauth.kakao.com/oauth/token`)에 요청을 보냅니다.
        
    - ⚠️ **주의:** 이때 파라미터로 넣는 `redirect_uri`는 프론트엔드 SDK에 적었던 주소와 **토씨 하나 안 틀리고 똑같아야** 합니다.
        
3. **사용자 정보 조회 (수동):**
    
    - 받은 토큰으로 카카오(`https://kapi.kakao.com/v2/user/me`)에 요청해 이메일/닉네임을 받습니다.
        
4. **JWT 발급 및 리다이렉트:**
    
    - DB 조회/저장 후 우리 서버의 JWT(Access/Refresh)를 만들어서 프론트엔드(`/oauth/callback`)로 리다이렉트합니다.



---

### 🚀 SDK 로그인 전체 흐름도 (총 4단계)

#### 1단계: 프론트엔드 - "카카오야, 앱 켜줘!" (백엔드 모름)

사용자가 `Login.jsx`에서 버튼을 클릭합니다.

- **행동:** `window.Kakao.Auth.authorize({ redirectUri: '백엔드주소' })` 실행.
    
- **동작:**
    
    - 브라우저가 **카카오톡 앱**을 실행시킵니다. (모바일)
        
    - 사용자가 앱에서 **"동의하고 계속하기"**를 누릅니다.
        
- **백엔드 상태:** 😴 **자고 있음.** (로그인이 시작된 줄도 모름)
    

#### 2단계: 카카오 - "백엔드야, 이 사람 인증됐어!" (배달)

카카오 인증 서버가 사용자의 브라우저를 **지정된 `redirectUri`(백엔드)**로 강제 이동시킵니다.

- **행동:** 카카오가 브라우저 주소창을 아래 주소로 바꿉니다.
    
    - `http://백엔드주소/api/auth/kakao/callback?code=초강력인증코드`
        
- **백엔드 상태:** 😲 **깜짝 놀람.**
    
    - "갑자기 `/api/auth/kakao/callback`으로 요청이 들어왔네?"
        
    - **"파라미터를 보니 `code`(인증 코드)가 있네?"**
        

> **Q. 백엔드에서는 뭘 받는 거야?**
> 
> **A. 딱 하나, `code`(인증 코드)만 받습니다.**
> 
> 이 코드는 **"아직 토큰 아님, 토큰으로 바꿀 수 있는 임시 교환권"**입니다. 이 교환권은 유효기간이 매우 짧고(약 1분), 한 번 쓰면 사라집니다.

#### 3단계: 백엔드(수동 컨트롤러) - "이 쿠폰 진짜인지 확인해볼까?" (교환)

이제 우리가 만든 **`KakaoAuthController`**가 일을 시작합니다.

- **행동 1 (토큰 요청):** 백엔드가 카카오 서버(`https://kauth.kakao.com/oauth/token`)에 전화를 겁니다.
    
    - "카카오야, 내가 `초강력인증코드` 이거 받았는데, 이거 진짜면 **Access Token**이랑 바꿔줘."
        
- **행동 2 (토큰 수령):** 카카오가 "어, 진짜네? 자, 여기 토큰." 하고 줍니다.
    
- **행동 3 (정보 조회):** 백엔드가 다시 카카오(`https://kapi.kakao.com/v2/user/me`)에 요청합니다.
    
    - "이 토큰 가진 사람 누구야? 이메일이랑 닉네임 내놔."
        
- **행동 4 (DB 처리):** 받아온 정보로 회원가입 시키거나 로그인 처리합니다.
    

#### 4단계: 백엔드 -> 프론트 - "로그인 끝났다, 받아라!" (완료)

모든 처리가 끝나면 백엔드가 프론트엔드로 사용자를 다시 보냅니다.

- **행동:** 백엔드가 브라우저를 프론트엔드 주소로 리다이렉트(`302`) 시킵니다.
    
    - `http://프론트엔드주소/oauth/callback?accessToken=우리서버JWT&refreshToken=우리서버리프레시`
        
- **프론트엔드 상태:** 😍 **행복.**
    
    - 주소창에 있는 토큰을 꺼내서 `localStorage`에 저장하고 메인 페이지로 이동.
        

---

### ⚡ 요약: SDK 방식의 핵심 차이

|**구분**|**일반 방식 (Rest API)**|**SDK 방식**|
|---|---|---|
|**로그인 시작**|백엔드를 거쳐서 카카오로 감|**카카오로 바로 감** (앱 실행)|
|**백엔드의 인지**|"내가 보낸 애구나" (State 있음)|**"넌 누구냐?" (State 없음)**|
|**백엔드가 받는 것**|`code` + `state` (보안키)|**오직 `code` 뿐**|
|**처리 방법**|Spring Security가 **자동 처리**|개발자가 Controller로 **수동 처리**|

### 👨‍💻 결론

SDK 방식을 쓰시게 되면, 백엔드(`Controller`)는 **"갑자기 날아온 `code` 하나를 붙들고, 이게 진짜인지 카카오에 물어보고 토큰으로 바꿔오는 과정"**을 직접 코드로 짜주셔야 합니다.

이 과정이 바로 앞서 설명드린 **"수동 컨트롤러 구현"** 단계입니다.