
## 1. Clinet: 카카오 SDK 수동 로그인을 위한 OpenFiegn
- KakaoOauthTokenClient
	- 카카오에 등록한 Redirect URI로 받은 Code값을 이용
	- 백엔드 <-> 카카오 OAuth API간 사용가능한 토큰 발급
- KakaoOauthuserInfoClient
	- 카카오 OAuth API에서 발급한 access 토큰을 이용
	- 이 토큰을 가지고 유저 정보(이메일,실명) 요청

## 2. Controller: JWT 토큰 컨트롤러
- AuthController
	- /auth/refresh: access token이 만료되면 accessToken과 refreshToken 재발급
	- /auth/logout: refresh token을 쿠키에서 삭제하여 로그아웃
- KakaoSdkOauthController
	- /auth/kakao/callback
		- SDK로그인 방식을 사용하면 Security Filter Chain이 자동으로 카카오 OAuth 로그인을 해주지 못함
		- 수동으로 코드와 토큰을 받아서 프론트엔드와 백엔드간 JWT 토큰을 만들어줌
		- **중요: query에 accessToken뿐 아니라 role도 붙혀서 보내야함**
		- OAuth2SuccessHandler가 자동으로 수행하는 로직을 수동으로

## 3. DTO
- CustomOAuth2User 
	- **Spring Security와 비즈니스 로직(MemberDto) 간의 어댑터(Adapter)** 
	- Spring Security는 우리가 만든 `MemberDto`를 직접 이해하지 못하므로, 표준 인터페이스인 `OAuth2User`를 구현하여 감싸주는 역할 
	- **주요 기능**: - `SecurityContext` 저장용: 로그인 성공 후, Spring Security의 세션(혹은 컨텍스트)에 유저 정보를 저장할 때 사용됨 - `getAuthorities()`: 유저의 Role(권한)을 시큐리티에 전달하여 API 접근 제어(인가)를 가능하게 함 - 편의성 제공: 컨트롤러에서 `@AuthenticationPrincipal`을 통해 현재 로그인한 사용자의 이메일이나 이름을 쉽게 꺼내 쓸 수 있음
- KakaoOauthResponse
	- TokenResponse: code를 보내서 카카오로부터 토큰을 받아올때의 구조
	- UserInfoResponse: 토큰을 보내서 사용자의 정보를 받아올때의 구조
		- kakaoAccount와 Profile로 구성되어있음


## 4. Handler
- CustomAuthenticationEntryPoint
	- Access Token에서 예외가 발생하면 상황에 맞게 응답
		- 만료일때: TOKEN_EXPIRED를 리턴함 -> 프론트가 /auth/refresh 요청을 보내서 다시 accessToken을 받급 받음
		- 없을때: LOGIN_REQUIRED을 리턴함 -> 프론트가 로그인 페이지로 이동시킴
- OAuth2SuccessHandler
	- **자동으로 로그인 하는 Kakao RestAPI나 google일때만 실행**
	- CustomOAuth2UserService에서 만든 CustomOAuth2User를 이용
	- access token과 refresh token을 발급
	- refresh token을 저장
	- access token을 application.yml에 등록한 프론트 redirectURI로 전달
	- **중요: query에 accessToken뿐 아니라 role도 붙혀서 보내야함**


## 5. Service
- CustomOAuth2UserService
	- 유저 정보를 가져와서 DB에 저장 or 업데이트
	- DTO의 CustomOAuth2User로 반환(OAuth2SuccessHandler에 사용하기위해)
	- **중요:nickname이 있으면 ROLE_USER로 null이면 ROLE_GUEST로 설정해야함**
- KakaoSdkOauthService
	- 카카오 sdk에 필요한 내부 로직 수행
		1. code로 토큰 받기
		2. 토큰으로 이메일,실명 받기
		3. 유저 정보 저장/업데이트(DB)
		4. **중요:nickname이 있으면 ROLE_USER로 null이면 ROLE_GUEST로 설정해야함**
	- CustomOAuth2UserService가 자동으로 수행하는 로직을 수동으로